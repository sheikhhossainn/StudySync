<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/mentorship.css">
    <script src="assets/js/config.js"></script>
    <script src="assets/js/shared-auth.js"></script>
    <title>Find your mentor - StudySync</title>
    <style>
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .mentor-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .mentor-actions .btn {
            flex: 1;
            min-width: 100px;
        }
        /* Grid layout improvements */
        .mentors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .mentor-card {
            max-width: 500px;
            margin: 0 auto;
        }
        /* Modal for details */
        .details-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .details-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .details-modal .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .details-modal .close:hover {
            color: black;
        }
        
        /* Mentor message styling */
        .mentor-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 30px;
            margin-top: 20px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .mentor-message-content i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .mentor-message-content h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .mentor-message-content p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">StudySync</a>
            <nav class="nav">
                <a href="my-posts.html" class="nav-link">My Posts</a>
                <a href="mentorship.html" class="nav-link active">Mentorship</a>
                <a href="payment.html" class="nav-link">Payment</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <!-- Dynamic auth section - will be updated by shared-auth.js -->
                <div id="navAuthSection">
                    <a href="user-selection.html" class="btn btn-primary" id="loginBtn">Log in</a>
                    <div class="user-avatar-dropdown" id="userAvatarSection" style="display: none;">
                        <img id="navUserAvatar" src="https://via.placeholder.com/40/3b82f6/ffffff?text=U" alt="User Avatar" class="user-avatar" onclick="toggleDropdown()">
                        <div id="userDropdown" class="dropdown-content">
                            <a href="profile.html">üë§ Profile Settings</a>
                            <a href="#" onclick="logout()">üö™ Logout</a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="hero-section">
                <h1 class="hero-title">Find your mentor</h1>
                <p class="hero-subtitle">Post your goals and get guidance from experienced mentors in your field.</p>
                <button class="btn btn-primary btn-large" onclick="openMentorshipModal()">Post a Mentorship Request</button>
                
                <!-- Mentor-specific message (hidden by default) -->
                <div id="mentorMessage" class="mentor-message" style="display: none;">
                    <div class="mentor-message-content">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <h3>Welcome, Mentor!</h3>
                        <p>Browse through student mentorship requests below and click "Apply" to offer your guidance.</p>
                    </div>
                </div>
            </div>

            <!-- Mentorship Requests Section -->
            <div class="mentorship-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Mentorship Requests</h2>
                    <p class="section-subtitle">Students seeking guidance from experienced mentors</p>
                </div>
                
                <div class="mentorship-requests" id="mentorshipRequests">
                    <!-- Loading indicator -->
                    <div id="mentorshipLoadingIndicator" class="loading-indicator">
                        <div class="loading-spinner"></div>
                        <p>Loading mentorship requests...</p>
                    </div>
                    
                    <!-- Mentorship requests will be loaded dynamically here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Mentorship Request Modal -->
    <div id="mentorshipModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Mentorship Request</h2>
                <span class="close" onclick="closeMentorshipModal()">&times;</span>
            </div>
            <form id="mentorshipForm" class="post-form">
                <div class="form-group">
                    <label for="mentorshipTitle">Title *</label>
                    <input type="text" id="mentorshipTitle" name="title" required maxlength="255" 
                           placeholder="e.g., Seeking mentor for software engineering career guidance">
                </div>
                
                <div class="form-group">
                    <label for="mentorshipDescription">Description *</label>
                    <textarea id="mentorshipDescription" name="description" required rows="4" 
                              placeholder="Describe your goals, current situation, and what kind of guidance you're looking for..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="targetRole">Target Role/Goal *</label>
                        <input type="text" id="targetRole" name="target_role" required 
                               placeholder="e.g., Software Engineer at FAANG, Data Scientist, etc.">
                    </div>
                    
                    <div class="form-group">
                        <label for="mentorshipField">Field/Industry *</label>
                        <select id="mentorshipField" name="field" required>
                            <option value="">Select field</option>
                            <option value="software_engineering">Software Engineering</option>
                            <option value="data_science">Data Science</option>
                            <option value="machine_learning">Machine Learning</option>
                            <option value="product_management">Product Management</option>
                            <option value="ui_ux_design">UI/UX Design</option>
                            <option value="cybersecurity">Cybersecurity</option>
                            <option value="devops">DevOps</option>
                            <option value="mobile_development">Mobile Development</option>
                            <option value="web_development">Web Development</option>
                            <option value="finance">Finance</option>
                            <option value="marketing">Marketing</option>
                            <option value="consulting">Consulting</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="topicsNeeded">Topics/Skills Needed *</label>
                        <input type="text" id="topicsNeeded" name="topics" required 
                               placeholder="e.g., System Design, DSA, Interview Prep, Portfolio Review">
                    </div>
                    
                    <div class="form-group">
                        <label for="experienceLevel">Your Experience Level *</label>
                        <select id="experienceLevel" name="experience_level" required>
                            <option value="">Select level</option>
                            <option value="student">Student</option>
                            <option value="entry_level">Entry Level (0-1 years)</option>
                            <option value="junior">Junior (1-3 years)</option>
                            <option value="mid_level">Mid Level (3-5 years)</option>
                            <option value="senior">Senior (5+ years)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="preferredTime">Preferred Meeting Time</label>
                        <select id="preferredTime" name="preferred_time">
                            <option value="">Select time preference</option>
                            <option value="morning">Morning (6 AM - 12 PM)</option>
                            <option value="afternoon">Afternoon (12 PM - 6 PM)</option>
                            <option value="evening">Evening (6 PM - 11 PM)</option>
                            <option value="weekend">Weekends</option>
                            <option value="flexible">Flexible</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sessionFrequency">Session Frequency</label>
                        <select id="sessionFrequency" name="session_frequency">
                            <option value="">Select frequency</option>
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Bi-weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="as_needed">As needed</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="budget">Budget (per month) *</label>
                        <select id="budget" name="budget" required>
                            <option value="">Select budget range</option>
                            <option value="free">Free/Volunteer</option>
                            <option value="under_500">Under $500</option>
                            <option value="500_1000">$500 - $1000</option>
                            <option value="1000_2000">$1000 - $2000</option>
                            <option value="2000_3000">$2000 - $3000</option>
                            <option value="3000_5000">$3000 - $5000</option>
                            <option value="above_5000">Above $5000</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="mentorshipDuration">Expected Duration</label>
                        <select id="mentorshipDuration" name="duration">
                            <option value="">Select duration</option>
                            <option value="1_month">1 Month</option>
                            <option value="3_months">3 Months</option>
                            <option value="6_months">6 Months</option>
                            <option value="1_year">1 Year</option>
                            <option value="ongoing">Ongoing</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="additionalInfo">Additional Information</label>
                    <textarea id="additionalInfo" name="additional_info" rows="3" 
                              placeholder="Any specific requirements, timeline, or additional context..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMentorshipModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Post Mentorship Request</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mentorship Details Modal -->
    <div id="detailsModal" class="details-modal">
        <div class="details-modal-content">
            <span class="close" onclick="closeDetailsModal()">&times;</span>
            <div id="detailsContent">
                <!-- Details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Load user data and mentorship requests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadMentorshipRequests();
            setupEventListeners();
        });

        function checkLoginStatus() {
            const accessToken = localStorage.getItem('access_token');
            const userData = localStorage.getItem('user_data');
            
            const loginBtn = document.getElementById('loginBtn');
            const userAvatarSection = document.getElementById('userAvatarSection');
            const postButton = document.querySelector('.btn-large');
            
            if (accessToken && userData) {
                // User is logged in - show avatar dropdown
                if (loginBtn) loginBtn.style.display = 'none';
                if (userAvatarSection) userAvatarSection.style.display = 'block';
                
                // Load avatar using EXACT same logic as profile page
                try {
                    const user = JSON.parse(userData);
                    updateNavbarAvatar(user, user.profile);
                    
                    // Check user type and show/hide post button accordingly
                    checkUserRoleAndUpdateUI(user);
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    updateNavbarAvatar({ first_name: 'User', last_name: '' }, null);
                }
            } else {
                // User is not logged in - show login button and hide post button
                if (loginBtn) loginBtn.style.display = 'inline-block';
                if (userAvatarSection) userAvatarSection.style.display = 'none';
                if (postButton) postButton.style.display = 'none';
            }
        }

        function checkUserRoleAndUpdateUI(user) {
            const postButton = document.querySelector('.btn-large');
            const heroSubtitle = document.querySelector('.hero-subtitle');
            const mentorMessage = document.getElementById('mentorMessage');
            
            // Check if user is a student or mentor
            // This could come from user.user_type, user.is_mentor, or user.role
            const userType = user.user_type || user.role || (user.is_mentor ? 'mentor' : 'student');
            
            console.log('User type detected:', userType);
            
            if (userType === 'student') {
                // Students can post mentorship requests
                if (postButton) {
                    postButton.style.display = 'inline-block';
                    postButton.textContent = 'Post a Mentorship Request';
                }
                if (heroSubtitle) {
                    heroSubtitle.textContent = 'Post your goals and get guidance from experienced mentors in your field.';
                }
                if (mentorMessage) {
                    mentorMessage.style.display = 'none';
                }
            } else if (userType === 'mentor') {
                // Mentors cannot post, only respond to requests
                if (postButton) {
                    postButton.style.display = 'none';
                }
                if (heroSubtitle) {
                    heroSubtitle.textContent = 'Browse mentorship requests from students and offer your guidance.';
                }
                if (mentorMessage) {
                    mentorMessage.style.display = 'block';
                }
            } else {
                // Default behavior for unknown roles
                if (postButton) postButton.style.display = 'none';
                if (mentorMessage) mentorMessage.style.display = 'none';
            }
        }

        // EXACT same avatar logic as working profile page
        function updateNavbarAvatar(user, profile = null) {
            const firstName = user?.first_name || '';
            const lastName = user?.last_name || '';
            
            // Update navbar avatar with smaller default (EXACT same as profile page)
            const navDefaultAvatar = 'https://via.placeholder.com/40/3b82f6/ffffff?text=' + 
                encodeURIComponent((firstName[0] || '') + (lastName[0] || ''));
            const navAvatarSrc = profile?.profile_picture || user?.profile_picture || navDefaultAvatar;
            
            const navAvatar = document.getElementById('navUserAvatar');
            if (navAvatar) {
                navAvatar.src = navAvatarSrc;
                console.log('‚úÖ Mentorship page avatar loaded:', navAvatarSrc);
            }
        }

        // ========================
        // MODAL OPERATIONS
        // ========================
        
        function openMentorshipModal() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                showNotification('Please log in to create a mentorship request.', 'error');
                setTimeout(() => window.location.href = 'user-selection.html', 2000);
                return;
            }
            
            document.getElementById('mentorshipModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeMentorshipModal() {
            document.getElementById('mentorshipModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('mentorshipForm').reset();
        }

        // ========================
        // EVENT LISTENERS SETUP
        // ========================
        
        function setupEventListeners() {
            // Mentorship form submission
            const mentorshipForm = document.getElementById('mentorshipForm');
            if (mentorshipForm) {
                mentorshipForm.addEventListener('submit', handleMentorshipSubmission);
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('mentorshipModal');
                if (event.target === modal) {
                    closeMentorshipModal();
                }
            });
        }

        // ========================
        // MENTORSHIP REQUEST SUBMISSION
        // ========================
        
        async function handleMentorshipSubmission(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                // Show loading state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating...';
                
                const formData = new FormData(event.target);
                
                // Debug: Log all form data entries
                console.log('=== FormData Debug ===');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}:`, value, typeof value);
                }
                
                const mentorshipData = {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    target_role: formData.get('target_role'),
                    field: formData.get('field'),
                    topics: formData.get('topics'),
                    experience_level: formData.get('experience_level'),
                    preferred_time: formData.get('preferred_time') || null,
                    session_frequency: formData.get('session_frequency') || null,
                    budget: formData.get('budget'),
                    duration: formData.get('duration') || null,
                    additional_info: formData.get('additional_info') || null
                };
                
                console.log('=== Final Data ===');
                console.log('mentorshipData:', mentorshipData);

                // Validate required fields
                if (!mentorshipData.title || !mentorshipData.description || !mentorshipData.target_role || 
                    !mentorshipData.field || !mentorshipData.topics || !mentorshipData.experience_level || 
                    !mentorshipData.budget) {
                    throw new Error('Please fill in all required fields.');
                }

                // API call to create mentorship request
                const response = await fetch(`${window.StudySyncConfig?.API_BASE_URL || 'http://127.0.0.1:8000'}/api/mentorship/requests/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(mentorshipData)
                });

                if (response.ok) {
                    const newRequest = await response.json();
                    closeMentorshipModal();
                    showNotification('Mentorship request created successfully! üéâ', 'success');
                    loadMentorshipRequests(); // Reload the requests
                } else {
                    const errorData = await response.json();
                    console.error('Server error:', errorData);
                    
                    if (response.status === 401) {
                        showNotification('Session expired. Please log in again.', 'error');
                        localStorage.clear();
                        setTimeout(() => window.location.href = 'user-selection.html', 2000);
                    } else {
                        const errorMessage = errorData.detail || 
                                           errorData.message ||
                                           'Failed to create mentorship request. Please try again.';
                        showNotification(errorMessage, 'error');
                    }
                }
            } catch (error) {
                console.error('Error creating mentorship request:', error);
                showNotification(error.message || 'Network error. Please check your connection.', 'error');
            } finally {
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // ========================
        // LOAD MENTORSHIP REQUESTS
        // ========================
        
        async function loadMentorshipRequests() {
            try {
                console.log('Loading mentorship requests...');
                
                const response = await fetch(`${window.StudySyncConfig?.API_BASE_URL || 'http://127.0.0.1:8000'}/api/mentorship/requests/`);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    // Handle both paginated and non-paginated responses
                    const requests = data.results || data;
                    console.log('Mentorship requests to display:', requests);
                    
                    displayMentorshipRequests(requests);
                } else {
                    console.error('Failed to load mentorship requests:', response.status);
                    showErrorMessage('Failed to load mentorship requests. Please try again later.');
                }
            } catch (error) {
                console.error('Error loading mentorship requests:', error);
                showErrorMessage('Network error. Please check your connection.');
            }
        }

        function displayMentorshipRequests(requests) {
            const container = document.getElementById('mentorshipRequests');
            const loadingIndicator = document.getElementById('mentorshipLoadingIndicator');
            
            // Hide loading indicator
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<div class="no-requests"><p>No mentorship requests yet. Be the first to post one!</p></div>';
                return;
            }
            
            // Clear existing content
            container.innerHTML = '';
            
            requests.forEach(request => {
                const requestCard = createMentorshipRequestCard(request);
                container.appendChild(requestCard);
            });
        }

        function createMentorshipRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'mentor-card mentorship-request-card';
            card.setAttribute('data-request-id', request.id); // Add ID for easy removal
            
            // Check if this is the current user's request
            const currentUserId = localStorage.getItem('user_data') ? 
                JSON.parse(localStorage.getItem('user_data')).id : null;
            const isOwnRequest = currentUserId && request.author?.id === currentUserId;
            
            // Format budget display
            const budgetDisplay = formatBudget(request.budget);
            
            // Format time preference
            const timeDisplay = request.preferred_time ? formatTimePreference(request.preferred_time) : 'Flexible';
            
            card.innerHTML = `
                <div class="mentor-header">
                    <div class="user-avatar mentor-avatar">
                        <span>${getInitials(request.author?.first_name, request.author?.last_name)}</span>
                    </div>
                    <div class="mentor-info">
                        <h3 class="mentor-name">${request.author?.first_name || 'Anonymous'} ${request.author?.last_name || ''}</h3>
                        <div class="mentor-details">
                            <div class="detail-item">
                                <span class="detail-icon">üéØ</span>
                                <span class="detail-text">Target: ${request.target_role}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üìö</span>
                                <span class="detail-text">Topics: ${request.topics}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">‚è∞</span>
                                <span class="detail-text">Time: ${timeDisplay}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üí∞</span>
                                <span class="detail-text">Budget: ${budgetDisplay}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üìä</span>
                                <span class="detail-text">Level: ${formatExperienceLevel(request.experience_level)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üè¢</span>
                                <span class="detail-text">Field: ${formatField(request.field)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mentor-content">
                    <h4 class="mentorship-title">${request.title}</h4>
                    <p class="mentor-description">${request.description}</p>
                    ${request.additional_info ? `
                    <div class="additional-info">
                        <p><strong>Additional Info:</strong> ${request.additional_info}</p>
                    </div>
                    ` : ''}
                </div>
                <div class="mentor-footer">
                    <div class="mentor-actions">
                        ${!isOwnRequest ? `
                        <button class="btn btn-primary" onclick="contactMentee('${request.id}')">Offer Mentorship</button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="viewMentorshipDetails('${request.id}')">View Details</button>
                        ${isOwnRequest ? `
                        <button class="btn btn-danger" onclick="deleteMentorshipRequest('${request.id}')">Delete Request</button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return card;
        }

        // ========================
        // UTILITY FUNCTIONS
        // ========================
        
        function getInitials(firstName, lastName) {
            const first = firstName ? firstName.charAt(0).toUpperCase() : '';
            const last = lastName ? lastName.charAt(0).toUpperCase() : '';
            return first + last || 'U';
        }

        function formatBudget(budget) {
            const budgetMap = {
                '10000_20000': '‡ß≥10,000 - ‡ß≥20,000',
                '20000_30000': '‡ß≥20,000 - ‡ß≥30,000',
                '30000_50000': '‡ß≥30,000 - ‡ß≥50,000',
                '50000_75000': '‡ß≥50,000 - ‡ß≥75,000',
                '75000_100000': '‡ß≥75,000 - ‡ß≥1,00,000',
                'above_100000': 'Above ‡ß≥1,00,000',
                // Legacy support for old values
                'free': '‡ß≥10,000 - ‡ß≥20,000',
                'under_500': '‡ß≥10,000 - ‡ß≥20,000',
                '500_1000': '‡ß≥20,000 - ‡ß≥30,000',
                '1000_2000': '‡ß≥30,000 - ‡ß≥50,000',
                '2000_3000': '‡ß≥50,000 - ‡ß≥75,000',
                '3000_5000': '‡ß≥75,000 - ‡ß≥1,00,000',
                'above_5000': 'Above ‡ß≥1,00,000'
            };
            return budgetMap[budget] || budget;
        }

        function formatTimePreference(time) {
            const timeMap = {
                'morning': 'Morning',
                'afternoon': 'Afternoon',
                'evening': 'Evening',
                'weekend': 'Weekends',
                'flexible': 'Flexible'
            };
            return timeMap[time] || time;
        }

        function formatExperienceLevel(level) {
            const levelMap = {
                'student': 'Student',
                'entry_level': 'Entry Level',
                'junior': 'Junior',
                'mid_level': 'Mid Level',
                'senior': 'Senior'
            };
            return levelMap[level] || level;
        }

        function formatField(field) {
            const fieldMap = {
                'software_engineering': 'Software Engineering',
                'data_science': 'Data Science',
                'machine_learning': 'Machine Learning',
                'product_management': 'Product Management',
                'ui_ux_design': 'UI/UX Design',
                'cybersecurity': 'Cybersecurity',
                'devops': 'DevOps',
                'mobile_development': 'Mobile Development',
                'web_development': 'Web Development',
                'finance': 'Finance',
                'marketing': 'Marketing',
                'consulting': 'Consulting',
                'other': 'Other'
            };
            return fieldMap[field] || field;
        }

        function formatSessionFrequency(frequency) {
            const frequencyMap = {
                'once_week': 'Once per week',
                'twice_week': 'Twice per week',
                'three_times_week': 'Three times per week',
                'daily': 'Daily',
                'bi_weekly': 'Bi-weekly',
                'flexible': 'Flexible'
            };
            return frequencyMap[frequency] || frequency;
        }

        function formatDuration(duration) {
            const durationMap = {
                '1_month': '1 Month',
                '2_months': '2 Months',
                '3_months': '3 Months',
                '6_months': '6 Months',
                '1_year': '1 Year',
                'ongoing': 'Ongoing'
            };
            return durationMap[duration] || duration;
        }

        function contactMentee(requestId) {
            // TODO: Implement messaging/contact functionality
            showNotification('Contact functionality will be implemented soon!', 'info');
        }

        async function viewMentorshipDetails(requestId) {
            try {
                console.log('üìñ Loading details for request:', requestId);
                
                const response = await fetch(`${window.StudySyncConfig?.API_BASE_URL || 'http://127.0.0.1:8000'}/api/mentorship/requests/${requestId}/`);
                
                if (response.ok) {
                    const request = await response.json();
                    displayMentorshipDetails(request);
                } else {
                    console.error('Failed to load mentorship details:', response.status);
                    showNotification('Failed to load mentorship details. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error loading mentorship details:', error);
                showNotification('Network error. Please check your connection.', 'error');
            }
        }

        function displayMentorshipDetails(request) {
            const detailsContent = document.getElementById('detailsContent');
            const author = request.author || {};
            const authorName = `${author.first_name || ''} ${author.last_name || ''}`.trim() || author.email || 'Anonymous';
            
            // Check if this is the current user's request
            const currentUserId = localStorage.getItem('user_data') ? 
                JSON.parse(localStorage.getItem('user_data')).id : null;
            const isOwnRequest = currentUserId && author.id === currentUserId;
            
            detailsContent.innerHTML = `
                <div class="details-header">
                    <div class="user-avatar mentor-avatar" style="width: 60px; height: 60px; font-size: 24px;">
                        <span>${getInitials(author.first_name, author.last_name)}</span>
                    </div>
                    <div style="margin-left: 20px;">
                        <h2>${request.title}</h2>
                        <h3 style="color: #666; margin: 5px 0;">by ${authorName}</h3>
                        <p style="color: #888; margin: 0;">${formatTimeAgo(request.created_at)}</p>
                    </div>
                </div>
                
                <div class="details-body" style="margin-top: 30px;">
                    <div class="detail-section">
                        <h4>üéØ Target Goal</h4>
                        <p>${request.target_role}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>üìù Description</h4>
                        <p>${request.description}</p>
                    </div>
                    
                    <div class="details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="detail-section">
                            <h4>üíº Field</h4>
                            <p>${request.field_display || formatField(request.field)}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>üìö Topics/Skills</h4>
                            <p>${request.topics}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>üìà Experience Level</h4>
                            <p>${request.experience_level_display || formatExperienceLevel(request.experience_level)}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>üí∞ Budget</h4>
                            <p>${request.budget_display || formatBudget(request.budget)}</p>
                        </div>
                        
                        ${request.preferred_time ? `
                        <div class="detail-section">
                            <h4>üïê Preferred Time</h4>
                            <p>${request.preferred_time_display || formatTimePreference(request.preferred_time)}</p>
                        </div>
                        ` : ''}
                        
                        ${request.session_frequency ? `
                        <div class="detail-section">
                            <h4>üìÖ Session Frequency</h4>
                            <p>${request.session_frequency_display || formatSessionFrequency(request.session_frequency)}</p>
                        </div>
                        ` : ''}
                        
                        ${request.duration ? `
                        <div class="detail-section">
                            <h4>‚è±Ô∏è Expected Duration</h4>
                            <p>${request.duration_display || formatDuration(request.duration)}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${request.additional_info ? `
                    <div class="detail-section">
                        <h4>‚ÑπÔ∏è Additional Information</h4>
                        <p>${request.additional_info}</p>
                    </div>
                    ` : ''}
                    
                    <div class="details-actions" style="margin-top: 30px; text-align: center;">
                        ${!isOwnRequest ? `
                        <button class="btn btn-primary btn-large" onclick="contactMentee('${request.id}'); closeDetailsModal();">
                            Offer Mentorship
                        </button>
                        ` : `
                        <p style="color: #666; font-style: italic;">This is your mentorship request</p>
                        `}
                    </div>
                </div>
            `;
            
            // Show the modal
            document.getElementById('detailsModal').style.display = 'block';
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Helper function for time formatting
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Recently';
            
            const now = new Date();
            const postDate = new Date(dateString);
            const diffMs = now - postDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return postDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Delete mentorship request function
        async function deleteMentorshipRequest(requestId) {
            if (!confirm('Are you sure you want to delete this mentorship request? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('üóëÔ∏è Deleting mentorship request:', requestId);

                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    showNotification('Please log in to delete your request.', 'error');
                    return;
                }

                const response = await fetch(`${window.StudySyncConfig?.API_BASE_URL || 'http://127.0.0.1:8000'}/api/mentorship/requests/${requestId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    console.log('‚úÖ Mentorship request deleted successfully');
                    showNotification('Mentorship request deleted successfully! üóëÔ∏è', 'success');
                    
                    // Remove the card from the DOM immediately
                    const card = document.querySelector(`[data-request-id="${requestId}"]`);
                    if (card) {
                        card.remove();
                    }
                    
                    // Reload the requests to ensure consistency
                    loadMentorshipRequests();
                } else if (response.status === 404) {
                    showNotification('Request not found or already deleted.', 'warning');
                    loadMentorshipRequests(); // Refresh to sync state
                } else if (response.status === 403) {
                    showNotification('You can only delete your own mentorship requests.', 'error');
                } else {
                    const errorData = await response.text();
                    console.error('‚ùå Delete failed:', errorData);
                    showNotification('Failed to delete request. Please try again.', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error deleting mentorship request:', error);
                showNotification('Network error. Please check your connection.', 'error');
            }
        }

        function showErrorMessage(message) {
            const container = document.getElementById('mentorshipRequests');
            const loadingIndicator = document.getElementById('mentorshipLoadingIndicator');
            
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            container.innerHTML = `<div class="error-message"><p>${message}</p></div>`;
        }

        // ========================
        // NOTIFICATION SYSTEM
        // ========================
        
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // ========================
        // DROPDOWN AND AUTH
        // ========================

        function toggleDropdown() {
            const dropdown = document.getElementById("userDropdown");
            if (dropdown) dropdown.classList.toggle("show");
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_data');
            window.location.href = 'index.html';
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.user-avatar')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }
    </script>
</body>
</html>
